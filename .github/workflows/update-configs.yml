name: Update Configs

on:
  schedule:
    - cron: '30 22 * * *' # UTC 22:30 = åŒ—äº¬æ—¶é—´ 06:30
  workflow_dispatch:
    inputs:
      category:
        description: 'é€‰æ‹©è¦æ›´æ–°çš„ç±»åˆ«'
        required: false
        type: choice
        options: [all, official, general, smart, mobile]
        default: all

permissions:
  contents: write

jobs:
  update-configs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Update Configs
        run: |
          # 1. èµ‹äºˆè„šæœ¬æ‰§è¡Œæƒé™ (å…³é”®æ­¥éª¤)
          chmod +x .github/scripts/*.sh

          # 2. å®šä¹‰è¿è¡Œåˆ¤æ–­é€»è¾‘
          should_run() {
            local target="$1"
            local input="${{ github.event.inputs.category || 'all' }}"
            local event="${{ github.event_name }}"
            
            if [[ "$event" == "schedule" ]] || [[ "$input" == "all" ]] || [[ "$input" == "$target" ]]; then
              return 0
            fi
            return 1
          }

          # 3. æŒ‰éœ€æ‰§è¡Œè„šæœ¬
          # ä½¿ç”¨ || true ç¡®ä¿å³ä½¿è„šæœ¬å†…éƒ¨æœ‰éé›¶é€€å‡ºç ï¼ˆæå°‘æ•°æƒ…å†µï¼‰ï¼Œä¹Ÿä¸ä¼šä¸­æ–­åç»­æ­¥éª¤
          
          if should_run "official"; then
            bash .github/scripts/download-official.sh || echo "âš ï¸ Official update had warnings"
          fi

          if should_run "general"; then
            bash .github/scripts/download-general.sh || echo "âš ï¸ General update had warnings"
          fi

          if should_run "smart"; then
            bash .github/scripts/download-smart.sh || echo "âš ï¸ Smart update had warnings"
          fi

          if should_run "mobile"; then
            bash .github/scripts/download-mobile.sh || echo "âš ï¸ Mobile update had warnings"
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # å¼ºåˆ¶æ·»åŠ ç›®å½•ï¼Œå¿½ç•¥ç©ºç›®å½•é”™è¯¯
          git add Official_Examples General_Config Smart_Mode Mobile_Modules || true

          # æ£€æŸ¥æš‚å­˜åŒºæ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit. Workflow finished."
            exit 0
          fi

          git commit -m "ğŸ”„ Update configs $(date +'%Y-%m-%d')"
          git push
